name: Deployment Pipeline

# env:
    # ARTIFACT_REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev
    # REGISTRY_REPO_NAME: "rmr-alpha"
    # IMAGE_NAME: "api"
    # IMAGE_URL: "$ARTIFACT_REGISTRY/${{ secrets.GCP_PROJECT_ID }}/$REGISTRY_REPO_NAME/$IMAGE_NAME"

on:
  workflow_dispatch:

jobs:
# /////////////////////////////////////////////////////////////////////////////
# /////////////////////////////////////////////////////////////////////////////
# /////////////////////////////////////////////////////////////////////////////
  api-image:
    name: Checkout, Build and Push API Image
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME_API }}
          path: ${{ vars.REPO_NAME_API }}
      
      - name: Print the checked out repo content
        run: |
          repo_url=https://github.com/${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME_API }}.git
          latest_tag=$(git ls-remote --tags $repo_url | sort -u -r | head -n 1 | grep -o "v.*")          
          
          cd ${{ vars.REPO_NAME_API }}
          
          echo "This is the contents of the checked out repo:"
          ls -la
          
          echo "This is the last release tag of the repository:"
          echo "Latest tag: $latest_tag"
# /////////////////////////////////////////////////////////////////////////////
# /////////////////////////////////////////////////////////////////////////////
# /////////////////////////////////////////////////////////////////////////////
  webapp-image:
    name: Checkout, Build and Push Webapp Image
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          repository: ${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME_WEBAPP }}
          path: ${{ vars.REPO_NAME_WEBAPP }}
      
      - name: Print the checked out repo content
        run: |
          repo_url=https://github.com/${{ vars.REPO_OWNER }}/${{ vars.REPO_NAME_WEBAPP }}.git
          latest_tag=$(git ls-remote --tags $repo_url | sort -u -r | head -n 1 | grep -o "v.*")          
          
          cd ${{ vars.REPO_NAME_WEBAPP }}
          
          echo "This is the contents of the checked out repo:"
          ls -la
          
          echo "This is the last release tag of the repository:"
          echo "Latest tag: $latest_tag"

  # deploy:
  #   name: Deployig To Environment
  #   runs-on: ubuntu-latest
  #   needs: 
  #     - build-test
  #     - semantic-release

  #   steps:
  #     - name: Check out repository
  #       uses: actions/checkout@v4

  #     #######################################################################
  #     - name: Authenticate to Google Cloud
  #       uses: google-github-actions/auth@v2.1.7
  #       with:
  #         credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

  #     #######################################################################
  #     - name: Build Docker Image
  #       run: |
  #         image=${{ env.IMAGE_URL }}:${{ needs.semantic-release.outputs.IMAGE_TAG }}
  #         docker build -t $image ./api_service
      
  #     #######################################################################
  #     - name: Push to Artifact Registry
  #       run: |
  #         image=${{ env.IMAGE_URL }}:${{ needs.semantic-release.outputs.IMAGE_TAG }}
  #         gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}
  #         docker push $image